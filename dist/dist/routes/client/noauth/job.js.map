{"version":3,"sources":["../../../../routes/client/noauth/job.js"],"names":["_","require","async","express","NodeGeocoder","db","router","Router","exports","GOOGLE_GEO_CONFIG","apiKey","formatter","httpAdapter","provider","geocoder","get","search_job","get_job","get_job_roles","post","JOB_KEYS","COMPANY_KEYS","JOB_ROLE_KEYS","JOB_TYPE_KEYS","SKILL_KEYS","LABEL_TO_RADIUS","walk","bike","metro","car","_make_job_from_results","results","console","log","result","job_ids","length","each","a_result","job","job_id","pick","job_role","job_type","company","skills","property_bag","JSON","parse","r","job_skill","skill_def","skill_type","push","job_skill_id","Object","assign","industry","job_schedule","req","res","sql","connectAndQuery","values","params","nestTables","error","sendStatus","status","send","search_location","body","location","query","search_string","search","search_industry","industry_id","search_job_type","job_type_id","search_radius_label","radius","search_lat","search_long","search_formatted","keys","indexOf","series","done","geocode","then","formattedAddress","latitude","longitude","catch","err","job_roles"],"mappings":"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","file":"job.js","sourcesContent":["'use strict';\n\nvar _ = require('lodash');\nvar async = require('async');\nvar express = require('express');\nvar NodeGeocoder = require('node-geocoder');\nvar db = require('../../../mysql_db_prod.js');\n\nvar router = new express.Router();\nexports.router = router;\n\nvar GOOGLE_GEO_CONFIG = {\n\tapiKey: 'AIzaSyAJwf4JXpI9MRGuZdYcOFT9-nq5lzbuPKI',\n\tformatter: null,\n\thttpAdapter: 'https',\n\tprovider: 'google'\n};\nvar geocoder = NodeGeocoder(GOOGLE_GEO_CONFIG);\n\nrouter.get('/1/jobs', search_job);\nrouter.get('/1/job/:job_id', get_job);\nrouter.get('/1/job_roles', get_job_roles);\n\nrouter.post('/1/jobs', search_job);\n\nvar JOB_KEYS = ['job_id', 'company_id', 'employer_id', 'title', 'pay_rate_min', 'pay_rate_max', 'job_schedule_id', 'min_gpa', 'school_level_id', 'description', 'responsibilities', 'activities', 'is_yobs_client', 'external_url', 'posted_at', 'takedown_at', 'is_deleted', 'location', 'latitude', 'longitude'];\nvar COMPANY_KEYS = ['company_id', 'name', 'industry_id', 'email_domain', 'property_bag', 'is_deleted'];\nvar JOB_ROLE_KEYS = ['job_role_id', 'job_role_name', 'job_role_descr'];\nvar JOB_TYPE_KEYS = ['job_type_id', 'job_type_name', 'job_type_descr'];\nvar SKILL_KEYS = ['skill_type_id', 'skill_type_name', 'skill_type_desc'];\nvar LABEL_TO_RADIUS = {\n\twalk: 1.25,\n\tbike: 4,\n\tmetro: 8,\n\tcar: 8\n};\n\nfunction _make_job_from_results(results) {\n\n\tconsole.log('nothing');\n\tconsole.log(results);\n\n\tvar result = [];\n\tvar job_ids = {};\n\n\tif (results.length) {\n\t\t_.each(results, function (a_result) {\n\t\t\tif (!job_ids[a_result.job.job_id]) {\n\t\t\t\t(function () {\n\t\t\t\t\tjob_ids[a_result.job.job_id] = true;\n\n\t\t\t\t\tvar job = _.pick(a_result.job, JOB_KEYS);\n\t\t\t\t\tvar job_role = _.pick(a_result.job_role, JOB_ROLE_KEYS);\n\t\t\t\t\tvar job_type = _.pick(a_result.job_type, JOB_TYPE_KEYS);\n\t\t\t\t\tvar company = _.pick(a_result.company, COMPANY_KEYS);\n\t\t\t\t\tvar skills = [];\n\n\t\t\t\t\tcompany.property_bag = JSON.parse(company.property_bag);\n\n\t\t\t\t\t_.each(results, function (r) {\n\t\t\t\t\t\tif (r.job.job_id == r.job_skill.job_id) {\n\t\t\t\t\t\t\tvar skill_def = _.pick(r.skill_type, SKILL_KEYS);\n\t\t\t\t\t\t\tskill_def.push(r.job_skill.job_skill_id);\n\t\t\t\t\t\t\tskills.push(skill_def);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tresult.push({\n\t\t\t\t\t\tjob: Object.assign({}, job, job_role, job_type),\n\t\t\t\t\t\tindustry: a_result.industry,\n\t\t\t\t\t\tjob_schedule: a_result.job_schedule,\n\t\t\t\t\t\tcompany: company,\n\t\t\t\t\t\tskills: skills\n\t\t\t\t\t});\n\t\t\t\t})();\n\t\t\t}\n\t\t});\n\t}\n\n\treturn result;\n}\n\nfunction get_job(req, res) {\n\tvar sql = \"SELECT job.*, company.* , industry.*, job_role.*, job_type.*, job_skill.*, job_schedule.*, skill_type.* \" + \"FROM job \" + \"JOIN company USING(company_id) \" + \"JOIN industry USING(industry_id) \" + \"JOIN job_role USING(job_role_id) \" + \"JOIN job_type USING(job_type_id) \" + \"LEFT JOIN job_schedule USING(job_schedule_id) \" + \"LEFT JOIN job_skill ON job_skill.job_id = job.job_id \" + \"LEFT JOIN skill_type ON job_skill.skill_type_id = skill_type.skill_type_id \" + \"WHERE job.job_id = ?\";\n\tdb.connectAndQuery({ sql: sql, values: [req.params.job_id], nestTables: true }, function (error, results) {\n\t\tif (error) {\n\t\t\tconsole.error(\"get_job: sql err:\", error);\n\t\t\tres.sendStatus(500);\n\t\t} else if (results.length < 1) {\n\t\t\tres.sendStatus(404);\n\t\t} else {\n\t\t\tvar result = _make_job_from_results(results);\n\t\t\tres.status(200).send(result[0]);\n\t\t}\n\t});\n}\nfunction search_job(req, res) {\n\n\tvar search_location = req.body.location || req.query.location;\n\tvar search_string = req.body.search || req.query.search;\n\tvar search_industry = req.body.industry_id || req.query.industry_id;\n\tvar search_job_type = req.body.job_type_id || req.query.job_type_id;\n\n\tvar search_radius_label = req.body.radius || req.query.radius;\n\tvar search_lat = void 0;\n\tvar search_long = void 0;\n\tvar search_formatted = void 0;\n\tvar result = void 0;\n\n\tif (Object.keys(LABEL_TO_RADIUS).indexOf(search_radius_label) < 0) {\n\t\tsearch_radius_label = 'bike';\n\t}\n\n\tasync.series([function (done) {\n\t\tgeocoder.geocode(search_location).then(function (res) {\n\t\t\tsearch_formatted = res[0].formattedAddress;\n\t\t\tsearch_lat = res[0].latitude;\n\t\t\tsearch_long = res[0].longitude;\n\t\t\tdone();\n\t\t}).catch(function (err) {\n\t\t\tconsole.error(\"search_job: geocoding err:\", err);\n\t\t\tdone(err);\n\t\t});\n\t}, function (done) {\n\t\tvar values = [search_lat, search_lat, search_long, search_long];\n\t\tvar sql = \"SELECT job.*, company.* , industry.*, job_role.*, job_type.*, job_skill.*, job_schedule.*, skill_type.* \" + \"FROM job \" + \"JOIN company USING(company_id) \" + \"JOIN industry USING(industry_id) \" + \"JOIN job_role USING(job_role_id) \" + \"JOIN job_type USING(job_type_id) \" + \"LEFT JOIN job_schedule USING(job_schedule_id) \" + \"LEFT JOIN job_skill ON job_skill.job_id = job.job_id \" + \"LEFT JOIN skill_type ON job_skill.skill_type_id = skill_type.skill_type_id \" + \"WHERE \" + \"(job.is_deleted = 0 OR job.is_deleted IS NULL) AND \" + \"job.latitude_lower_\" + search_radius_label + \" <= ? AND \" + \"job.latitude_upper_\" + search_radius_label + \" >= ? AND \" + \"job.longitude_lower_\" + search_radius_label + \" >= ? AND \" + \"job.longitude_upper_\" + search_radius_label + \" <= ?\";\n\n\t\tif (search_industry && (search_industry.length || search_industry >= 1)) {\n\t\t\tsql += \" AND company.industry_id IN (?)\";\n\t\t\tvalues.push(search_industry);\n\t\t}\n\t\tif (search_string) {\n\t\t\tsql += \" AND job.title LIKE ?\";\n\t\t\tvalues.push('%' + search_string + '%');\n\t\t}\n\t\tif (search_job_type && (search_job_type.length || search_job_type >= 1)) {\n\t\t\tsql += \" AND job.job_type_id IN (?)\";\n\t\t\tvalues.push(search_job_type);\n\t\t}\n\n\t\tdb.connectAndQuery({ sql: sql, values: values, nestTables: true }, function (error, results) {\n\t\t\tif (error) {\n\t\t\t\tconsole.error(\"search_job: sql err:\", error);\n\t\t\t} else {\n\t\t\t\tresult = _make_job_from_results(results);\n\t\t\t}\n\t\t\tdone(error);\n\t\t});\n\t}], function (error) {\n\t\tif (error) {\n\t\t\tres.sendStatus(500);\n\t\t} else {\n\t\t\tres.status(200).send(result);\n\t\t}\n\t});\n}\nfunction get_job_roles(req, res) {\n\tvar sql = \"SELECT * FROM job_role\";\n\tvar values = [];\n\tdb.connectAndQuery({ sql: sql, values: values }, function (error, results) {\n\t\tif (error) {\n\t\t\tconsole.error(\"get_job_roles: sql err:\", error);\n\t\t\tres.sendStatus(500);\n\t\t} else {\n\t\t\t(function () {\n\t\t\t\tvar job_roles = [];\n\t\t\t\t_.each(results, function (result) {\n\t\t\t\t\tjob_roles.push(_.pick(result, JOB_ROLE_KEYS));\n\t\t\t\t});\n\t\t\t\tres.status(200).send(job_roles);\n\t\t\t})();\n\t\t}\n\t});\n}\n//# sourceMappingURL=job.js.map"]}